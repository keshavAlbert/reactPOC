{"ast":null,"code":"import { STORE_CHANGE_EVENT, STORE_GLOBAL_KEY, STORE_READY_EVENT } from './state';\nconst STORAGE_KEY = 'reactBridgeSharedState';\nfunction cloneState(state) {\n  return {\n    selectedSection: state.selectedSection,\n    form: {\n      ...state.form\n    }\n  };\n}\nfunction createDefaultState() {\n  return {\n    selectedSection: 'overview',\n    form: {\n      title: 'Untitled note',\n      description: 'Start typing your notes in the React form.',\n      lastUpdated: new Date().toISOString()\n    }\n  };\n}\nfunction readPersistedState() {\n  if (typeof window === 'undefined') return null;\n  try {\n    const raw = window.localStorage?.getItem(STORAGE_KEY);\n    if (!raw) return null;\n    const parsed = JSON.parse(raw);\n    if (!parsed || typeof parsed !== 'object') return null;\n    return sanitizeState(parsed);\n  } catch {\n    return null;\n  }\n}\nfunction sanitizeState(candidate) {\n  const defaults = createDefaultState();\n  const form = {\n    ...defaults.form,\n    ...(candidate.form ?? {})\n  };\n  return {\n    selectedSection: candidate.selectedSection ?? defaults.selectedSection,\n    form: {\n      ...form,\n      lastUpdated: form.lastUpdated ?? new Date().toISOString()\n    }\n  };\n}\nfunction persistState(state) {\n  if (typeof window === 'undefined') return;\n  try {\n    window.localStorage?.setItem(STORAGE_KEY, JSON.stringify(state));\n  } catch {\n    // best-effort persistence; ignore write failures (e.g., quota exceeded)\n  }\n}\nfunction createStore(initial) {\n  const bootstrapped = initial ?? readPersistedState();\n  let state = bootstrapped ? cloneState(bootstrapped) : createDefaultState();\n  const listeners = new Set();\n  function notify() {\n    const snapshot = cloneState(state);\n    listeners.forEach(listener => listener(snapshot));\n    if (typeof window !== 'undefined') {\n      window.dispatchEvent(new CustomEvent(STORE_CHANGE_EVENT, {\n        detail: snapshot\n      }));\n    }\n    persistState(snapshot);\n  }\n  return {\n    getState() {\n      return cloneState(state);\n    },\n    setState(update) {\n      const hasFormUpdate = update.form !== undefined;\n      const nextForm = hasFormUpdate ? {\n        ...state.form,\n        ...update.form,\n        lastUpdated: new Date().toISOString()\n      } : state.form;\n      state = {\n        ...state,\n        ...update,\n        form: hasFormUpdate ? nextForm : state.form\n      };\n      notify();\n      return cloneState(state);\n    },\n    updateForm(update) {\n      const nextForm = {\n        ...state.form,\n        ...update,\n        lastUpdated: new Date().toISOString()\n      };\n      state = {\n        ...state,\n        form: nextForm\n      };\n      notify();\n      return cloneState(state);\n    },\n    subscribe(listener) {\n      listeners.add(listener);\n      listener(cloneState(state));\n      return () => listeners.delete(listener);\n    }\n  };\n}\nfunction setupStorageListener(updateState) {\n  if (typeof window === 'undefined') return;\n  const handler = event => {\n    if (event.key !== STORAGE_KEY) return;\n    try {\n      if (event.newValue == null) return;\n      const parsed = JSON.parse(event.newValue);\n      const next = sanitizeState(parsed);\n      updateState(next);\n    } catch {\n      /* ignore malformed payloads */\n    }\n  };\n  window.addEventListener('storage', handler);\n}\nfunction isSharedStore(candidate) {\n  if (!candidate || typeof candidate !== 'object') return false;\n  const maybe = candidate;\n  return typeof maybe.getState === 'function' && typeof maybe.setState === 'function' && typeof maybe.updateForm === 'function' && typeof maybe.subscribe === 'function';\n}\nexport function getOrCreateSharedStore(target = window) {\n  if (target[STORE_GLOBAL_KEY] && isSharedStore(target[STORE_GLOBAL_KEY])) {\n    return target[STORE_GLOBAL_KEY];\n  }\n  const store = createStore();\n  setupStorageListener(nextState => {\n    // Replace internal state by leveraging the public setState API to reuse notifications.\n    store.setState(nextState);\n  });\n  Object.defineProperty(target, STORE_GLOBAL_KEY, {\n    value: store,\n    enumerable: false,\n    configurable: false,\n    writable: false\n  });\n  if (typeof window !== 'undefined') {\n    window.dispatchEvent(new CustomEvent(STORE_READY_EVENT, {\n      detail: store\n    }));\n  }\n  return store;\n}\nexport function getSharedStore(target = window) {\n  const store = target[STORE_GLOBAL_KEY];\n  if (!store || !isSharedStore(store)) {\n    throw new Error('Shared store has not been initialised yet.');\n  }\n  return store;\n}","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}